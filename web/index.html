<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>TinyMark Editor</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
  <style>
    body { display: flex; flex-direction: column; font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f5f5f5; }
    header { background: #2c3e50; color: #fff; padding: 10px 20px; }
    #filename { font-size: 18px; margin: 0; }
    .toolbar { background: #ecf0f1; padding: 5px; border-bottom: 1px solid #ccc; display: flex; gap: 10px; }

    #editor { flex: 1 1 auto; background: white; min-height: 0; padding: 15px; margin: 5px; border: 1px solid #ccc; overflow: auto; }
    #status { font-size: 13px; color: #555; margin: 10px; }
    header, .toolbar, #status {
      flex: 0 0 auto;
    }
    h2 { text-transform: uppercase; font-weight: bold; }
    html, body { margin: 0; height: 100%; }
    .btn-group {
      display: inline-flex;
    }

    .btn-group button {
      font-family: "Material Symbols Outlined";
      font-size: 24px;
      line-height: 1;
      border: 1px solid #ccc;
      background: white;
      padding: 5px 7px;
      cursor: pointer;
    }

    .btn-group button:not(:first-child) {
      border-left: none; /* remove inner borders */
    }

    .btn-group button:first-child {
      border-top-left-radius: 4px;
      border-bottom-left-radius: 4px;
    }

    .btn-group button:last-child {
      border-top-right-radius: 4px;
      border-bottom-right-radius: 4px;
    }
  </style>
  <script src="https://apis.google.com/js/api.js"></script>
</head>
<body>
  <header><h1 id="filename">Untitled</h1></header>
  <div class="toolbar">
    <div class="btn-group">
      <button onclick="document.execCommand('undo')">undo</button>
      <button onclick="document.execCommand('redo')">redo</button>
    </div>
    <div class="btn-group">
      <button id="btnHeading" onclick="toggleHeading()">h_mobiledata_badge</button>
      <button id="btnBold" onclick="exec('bold')">format_bold</button>
      <button id="btnItalic" onclick="exec('italic')">format_italic</button>
      <button id="btnUnderline" onclick="exec('underline')">format_underlined</button>
    </div>
    <div class="btn-group">
      <button onclick="exec('insertUnorderedList')">format_list_bulleted</button>
      <button onclick="exec('insertOrderedList')">format_list_numbered</button>
    </div>
  </div>
  <div id="editor" contenteditable="true">start typing here…</div>
  <div id="status"></div>

  <script>
    let currentFileId = "<?= fileId ?>";
    let headingMode = false;

    let editor = document.getElementById("editor");
    editor.addEventListener("focus", beginEditing);

    let h1 = document.getElementById("filename");
    h1.addEventListener("click", enterRename);
    
    function beginEditing(event) {
      const content = event.target;
      content.replaceChildren();
      content.removeEventListener("focus", beginEditing);
    }
    
    function enterRename(event) {
      const node = event.target;
      const filename = node.innerText;
      let newNode = document.createElement('input');
      newNode.setAttribute("type", "text");
      newNode.value = filename;
      newNode.id = 'filename';
      newNode.addEventListener("change", renameFile);
      newNode.addEventListener("blur", exitRename);
      node.replaceWith(newNode);
      newNode.focus();
    }

    function exitRename(event) {
      const node = event.target;
      const filename = node.value;
      let newNode = document.createElement('h1');
      newNode.innerText = filename;
      newNode.id = 'filename';
      newNode.addEventListener("click", enterRename);
      node.replaceWith(newNode);
    }

    function renameFile(event) {
      const filename = event.target.value;
      console.log(filename);
      event.target.blur();
      // google.script.run.withSuccessHandler(function() {
      //    document.getElementById('status').textContent = 'Renamed ✔';
      // }).renameFile(currentFileId, filename);
    }

    function exec(cmd, arg) {
      document.execCommand(cmd, false, arg);
      updateToolbarState();
    }

    function toggleHeading() {
      headingMode = !headingMode;
      const btn = document.getElementById('btnHeading');
      btn.classList.toggle('active', headingMode);

      if (headingMode) {
        document.execCommand('formatBlock', false, '<h2>');
      } else {
        document.execCommand('formatBlock', false, '<p>');
      }
      updateToolbarState();
    }

    function updateToolbarState() {
      const sel = window.getSelection();
      if (!sel.rangeCount) return;
      let node = sel.anchorNode;
      while (node && node.nodeType === 3) node = node.parentNode;

      let inHeading = node && node.closest('h2');
      headingMode = !!inHeading;
      document.getElementById('btnHeading').classList.toggle('active', headingMode);

      // Disable inline styling if inside heading
      document.getElementById('btnBold').disabled = headingMode;
      document.getElementById('btnItalic').disabled = headingMode;
      document.getElementById('btnUnderline').disabled = headingMode;

      if (inHeading) {
        cleanHeading(node.closest('h2'));
      }
    }

    // Remove any styles except uppercase bold for headings
    function cleanHeading(h2) {
      if (!h2) return;
      h2.removeAttribute("style");
      h2.querySelectorAll("*").forEach(el => {
        el.replaceWith(el.textContent);
      });
    }

    // Track cursor changes
    document.addEventListener('selectionchange', updateToolbarState);

    function loadFile() {
      if (!currentFileId) return;
      google.script.run.withSuccessHandler(function(file) {
        if (!file) return;
        document.getElementById('editor').innerHTML = file.content
          .split(/\n/).map(line => `<p>${line}</p>`).join('');
        document.getElementById('status').textContent = 'Loaded: ' + file.name;
      }).getFileContent(currentFileId);
    }

    function saveFile() {
      const text = extractPlainText();
      google.script.run.withSuccessHandler(function() {
        document.getElementById('status').textContent = 'Saved ✔';
      }).saveTxtFile(currentFileId, text);
    }

    function extractPlainText() {
      const html = document.getElementById('editor').innerHTML;
      const container = document.createElement('div');
      container.innerHTML = html;
      const lines = [];
      container.querySelectorAll('p,h1,h2,h3,li').forEach(el => {
        lines.push((el.textContent || '').trim());
      });
      return lines.join('\n');
    }

    window.onload = loadFile;
  </script>
</body>
</html>
